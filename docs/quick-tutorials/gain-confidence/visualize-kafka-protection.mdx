---
sidebar_position: 2
title: Access graph - Kafka
---

import CodeBlock from "@theme/CodeBlock";
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

:::danger
Write intro
This tutorial is the second part in the **gain confidence** series. You are not required to run through the first tutorial in the series, but you will need to run through the **environment setup** steps to align your environment.
:::

In this tutorial, we will:

- Deploy a demo reference lab,
which is based on the [Google microservices demo](https://github.com/GoogleCloudPlatform/microservices-demo)
simulating an e-commerce application.
- Use the access graph to gain confidence in how Otterize can help in gradually rolling out secure access for Kafka.

## Prerequisites
<details>
<summary>Prepare a cluster that supports network policies</summary>

Before you start, you need a Kubernetes cluster with a [CNI](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/) that supports [NetworkPolicies](https://kubernetes.io/docs/concepts/services-networking/network-policies/).

{@include: ../../_common/cluster-setup.md}
</details>

<details>
<summary>Integrate Otterize Cloud with your cluster</summary>

{@include: ../../_common/install-otterize-cloud.md}
</details>

## Environment setup
### Deploy the reference lab with mTLS for Kafka and its clients

```bash
kubectl create namespace otterize-ecom-kafka-demo
kubectl apply -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/ecom-demo-mtls.yaml
```
<details>
<summary>Optional: check that the lab was deployed...</summary>
<div>


To see all the pods in the lab:
```bash
kubectl get pods -n otterize-ecom-kafka-demo
```
The pods should all be ready and running:
```bash
NAME                                     READY   STATUS    RESTARTS   AGE
adservice-694f4ff98-cz4nn                1/1     Running   0          23m
cartservice-85f8bc44fd-45cbk             1/1     Running   0          23m
checkoutservice-8fc47bbbd-9lhfv          1/1     Running   0          23m
currencyservice-597bdf576b-8hftc         1/1     Running   0          23m
emailservice-d5c6f74dd-qlwc4             1/1     Running   0          23m
frontend-7ffbf49884-j9rhz                1/1     Running   0          23m
loadgenerator-65779994db-tgdxk           1/1     Running   0          23m
paymentservice-76b9c8b87d-ktfcd          1/1     Running   0          23m
productcatalogservice-6969d4f5fd-xdw99   1/1     Running   0          23m
recommendationservice-58798d5c8-2f4rz    1/1     Running   0          23m
redis-cart-6f65887b5d-xwpz5              1/1     Running   0          23m
shippingservice-ff5f4d7d-qcjw8           1/1     Running   0          23m
```


  </div>
</details>
<details>
<summary>Optional: Browse the lab</summary>
<Tabs groupId="frontend-addr">
<TabItem value="k8s" label="K8s">

To get the externally-accessible URL where your demo front end is available, run:
```bash
kubectl get service -n otterize-ecom-kafka-demo frontend-external | awk '{print $4}'
```
The result should be similar to (if running on AWS EKS):
```
a11843075fd254f8099a986467098647-1889474685.us-east-1.elb.amazonaws.com
```
Go ahead and browse to the URL above to "shop" and get a feel for the reference lab's behavior.
(The URL might take some time to populate across DNS servers. Note that we are accessing an HTTP and not an HTTPS website.)
</TabItem>
<TabItem value="minikube" label="Minikube">

To get the externally-accessible URL where your demo front end is available, run:
```
kubectl port-forward -n otterize-ecom-kafka-demo service/frontend-external 8080:80 &
```
The demo is now accessible at:
```
http://localhost:8080
```
Go ahead and browse to the URL above to "shop" and get a feel for the reference lab's behavior.
</TabItem>
</Tabs>
</details>

### Apply intents for workloads
```bash
kubectl apply -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/all.yaml
```

## Manage Kafka access with Otterize

Let's connect Kafka with Otterize by applying a `KafkaServerConfig`:
```bash
kubectl apply -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/kafkaserverconfig.yaml
```
<details>
<summary>Expand to see the KafkaServerConfig</summary>
<Tabs>

<TabItem value="kafkaserverconfig.yaml" label="kafkaserverconfig.yaml">

```yaml
{@include: ../../..//static/code-examples/shadow-mode/kafkaserverconfig.yaml}
```

</TabItem>
</Tabs>
</details>

Upon applying the KafkaServerConfig, an ACL will configure Kafka to allow anonymous access all topics.
This will be the base state, from which we will gradually roll out secure access to Kafka.

We can see in the access graph that the node is marked with a `Kafka` and `KSC` icons.

![Kafka Server Config](/img/quick-tutorials/shadow-mode/KSC.png)

:::danger
Show how the KSC config looks like in the graph
:::

## Declare Kafka intents

Otterize can now configure Kafka ACLs so let's go ahead and create client intents files for the services communicating with Kafka.

<Tabs>
<TabItem value="checkoutservice" label="checkoutservice" default>

```yaml
{@include: ../../..//static/code-examples/shadow-mode/phase-4-checkout.yaml}
```
</TabItem>
<TabItem value="orderservice" label="orderservice" default>

```yaml
{@include: ../../..//static/code-examples/shadow-mode/phase-4-order.yaml}
```
</TabItem>
<TabItem value="paymentservice" label="paymentservice" default>

```yaml
{@include: ../../..//static/code-examples/shadow-mode/phase-4-payment.yaml}
```
</TabItem>
</Tabs>

And apply them with

```bash
kubectl apply -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/kafka-intents.yaml
```

You can verify that the reference lab still functions as intended.

In the access we can see that edges connecting to Kafka are marked with a Kafka icon.

![Kafka icon](/img/quick-tutorials/shadow-mode/phase-6.png)


Clicking on the edge between `orderservice` and `kafka` will allow us to inspect which topics are allowed for access by the `orderservice`.

![Kafka intent](/img/quick-tutorials/shadow-mode/kafka-intent.png)

## What's next

:::danger
To complete
:::

## Teardown

To remove the deployed reference lab run:

```bash
kubectl delete -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/kafka-intents.yaml
kubectl delete -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/all.yaml
kubectl delete -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/kafkaserverconfig.yaml
kubectl delete -n otterize-ecom-kafka-demo -f code-examples/shadow-mode/ecom-demo-mtls.yaml
kubectl delete namespace otterize-ecom-kafka-demo
```