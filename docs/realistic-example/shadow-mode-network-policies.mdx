---
sidebar_position: 1
title: Shadow mode - network policies
---

import CodeBlock from "@theme/CodeBlock";
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Otterize Cloud extends the capabilities of Otterize OSS. It lets you visualize discovered communication within your cluster using the access graph, apply intents and see what will happen to communication between your workloads before enforcing shadow mode, and gain real-time insights into how to roll out network policies.

In this tutorial, we will:

- Deploy a demo reference lab,
which is based on the [Google microservices demo](https://github.com/GoogleCloudPlatform/microservices-demo)
simulating an e-commerce application.
- Use the access graph and Shadow mode in tandem with intents to see how Otterize can help in gradually rolling out secure access.

## Prerequisites
<details>
<summary>Prepare a cluster that supports network policies</summary>

Before you start, you need a Kubernetes cluster with a [CNI](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/) that supports [NetworkPolicies](https://kubernetes.io/docs/concepts/services-networking/network-policies/).

{@include: ../_common/cluster-setup.md}
</details>

<details>
<summary>Integrate Otterize Cloud with your cluster (enforcement=false)</summary>

{@include: ../_common/install-otterize-cloud-enforcement-off.md}
</details>

## Deploy the reference lab

```bash
kubectl create namespace otterize-ecom-demo
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/ecom-demo.yaml
```

<details>
<summary>Optional: check that the lab was deployed...</summary>
<div>


To see all the pods in the lab:
```bash
kubectl get pods -n otterize-ecom-demo
```
The pods should all be ready and running:
```bash
NAME                                     READY   STATUS    RESTARTS      AGE
adservice-65494cbb9d-5lrv6               1/1     Running   0             115s
cartservice-6d84fc45bb-hdtwn             1/1     Running   0             115s
checkoutservice-5599486df-dvj9n          1/1     Running   3 (79s ago)   115s
currencyservice-6d64686d74-lxb7x         1/1     Running   0             115s
emailservice-7c6cbfbbd7-xjxlt            1/1     Running   0             115s
frontend-f9448d7d4-6dmnr                 1/1     Running   0             115s
kafka-0                                  1/1     Running   2 (83s ago)   115s
loadgenerator-7f6987f59-bchgm            1/1     Running   0             114s
orderservice-7ffdbf6df-wzzfd             1/1     Running   0             115s
otterize-ecom-demo-zookeeper-0           1/1     Running   0             115s
paymentservice-86855d78db-zjjfn          1/1     Running   0             115s
productcatalogservice-5944c7f666-2rjc6   1/1     Running   0             115s
recommendationservice-6c8d848498-zm2rm   1/1     Running   0             114s
redis-cart-6b79c5b497-xpms2              1/1     Running   0             115s
shippingservice-85694cb9bd-v54xp         1/1     Running   0             114s
```


</div>
</details>

<details>
<summary>Optional: Browse the lab</summary>
<Tabs groupId="frontend-addr">
<TabItem value="k8s" label="K8s">

To get the externally-accessible URL where your demo front end is available, run:
```bash
kubectl get service -n otterize-ecom-demo frontend-external | awk '{print $4}'
```
The result should be similar to (if running on AWS EKS):
```
a11843075fd254f8099a986467098647-1889474685.us-east-1.elb.amazonaws.com
```
Go ahead and browse to the URL above to "shop" and get a feel for the reference lab's behavior.
(The URL might take some time to populate across DNS servers. Note that we are accessing an HTTP and not an HTTPS website.)
</TabItem>
<TabItem value="minikube" label="Minikube">

To get the externally-accessible URL where your demo front end is available, run:
```
kubectl port-forward -n otterize-ecom-demo service/frontend-external 8080:80 &
```
The demo is now accessible at:
```
http://localhost:8080
```
Go ahead and browse to the URL above to "shop" and get a feel for the reference lab's behavior.
</TabItem>
</Tabs>
</details>

## Map the cluster

Locate your deployment in the [access graph](https://app.staging.otterize.com/access-graph). You should see the following map for the deployed lab.

<img src="/img/quick-tutorials/shadow-mode/phase-0.png" alt="Discovered intents" width="600"/>

The access graph allows you to quickly inspect your network, map services communication and prepare for gradual rollout using its **shadow mode** features.

## Try out IBAC with shadow mode
Let’s declare that the `frontend` intends to call the `recommendationservice`.

We expect this will provide secure access, allowing the intended access from the `fronted` while protecting the `recommendationservice` from unintended access.

```yaml
{@include: ../../static/code-examples/shadow-mode/phase-1.yaml}
```

Apply this intents file with
```bash
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/phase-1.yaml
```

Look at the access graph again:

<img src="/img/quick-tutorials/shadow-mode/phase-1.png" alt="Discovered intents" width="600"/>

We’re not enforcing access controls, but we can see the `frontend` will still be able to call the `recommendationservice`, and the latter would be protected from any other calls.

### Declare more intents
Let’s add another intent, this time from `recommendationservice` to `productcatalogservice`.

```yaml
{@include: ../../static/code-examples/shadow-mode/phase-2.yaml}
```

Apply this intents file with
```bash
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/phase-2.yaml
```

Look at the access graph again:

<img src="/img/quick-tutorials/shadow-mode/phase-2.png" alt="Discovered intents" width="600"/>

What happened? The access graph is warning us that when we’ll protect the `productcatalogservice`, only the `recommendationservice` will be able to reach it and the `frontend` and the `checkoutservice` will be blocked.

Let's add the required intents for the `checkoutservice` and `frontend`.

<Tabs>
<TabItem value="frontend" label="frontend" default>

```yaml
{@include: ../../static/code-examples/shadow-mode/phase-3-frontend.yaml}
```
</TabItem>
<TabItem value="checkout-service" label="checkout-service" default>

```yaml
{@include: ../../static/code-examples/shadow-mode/phase-3-checkout.yaml}
```
</TabItem>
</Tabs>

Apply these intents files with
```bash
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/phase-3.yaml
```

<img src="/img/quick-tutorials/shadow-mode/phase-3.png" alt="Discovered intents" width="600"/>

We can see how to roll out IBAC gradually: pick a service to protect, make sure its clients declare intents to call it and apply. The access graph and shadow mode allow us to gain confidence by highlighting any required configuration changes.

### Protect everything easily
Could we also bootstrap the whole cluster and protect it? Yes!

You can use the Otterize CLI ([Installation instructions](/installation#install-the-otterize-cli)) to export all discovered intents with the following command:
```bash
otterize network-mapper export -n otterize-ecom-demo --output-type dir --output intents
```

And apply them
```bash
kubectl apply -f intents
```

Or use our already generated intents with
```bash
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/all.yaml
```

Look at the access graph again:

<img src="/img/quick-tutorials/shadow-mode/phase-4.png" alt="Discovered intents" width="600"/>

Looks like everything is protected and nothing intended should be blocked.

## Enable enforcement
Otterize Cloud's shadow mode allowed us to gain confidence in the effects of
applying network policies using client intents and we can move on to enabling enforcement.

Let's enable enforcement with

{@include: ../_common/install-otterize-cloud.md}

<details>
<summary>See generated network policies</summary>
Otterize automatically generated network policies according to your declared (and applied) intents.

To list all generated network policies run
```bash
get netpol -n otterize-ecom-demo
```

let's inspect one of these network policies with
```bash
kubectl get netpol -n otterize-ecom-demo access-to-recommendationservice-from-otterize-ecom-demo -o yaml
```
And we will get the following output
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: access-to-recommendationservice-from-otterize-ecom-demo
  namespace: otterize-ecom-demo
  ...
spec:
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          intents.otterize.com/namespace-name: otterize-ecom-demo
      podSelector:
        matchLabels:
          intents.otterize.com/access-recommendationservic-otterize-ecom-demo-850ad9: "true"
  podSelector:
    matchLabels:
      intents.otterize.com/server: recommendationservic-otterize-ecom-demo-850ad9
  policyTypes:
  - Ingress
```
</details>


### Browse the lab
You can browse the lab using the browser to see it works as intended.

### Inspect the access graph
<img src="/img/quick-tutorials/shadow-mode/phase-5.png" alt="Discovered intents" width="600"/>

## What's next
- Learn how to [manage secure access for Kafka](/realistic-example/visualize-kafka-protection) using the demo lab tutorial.

## Teardown

To remove the deployed reference lab run:

```bash
kubectl delete -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/all.yaml
kubectl delete -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/ecom-demo.yaml
kubectl delete namespace otterize-ecom-demo
```