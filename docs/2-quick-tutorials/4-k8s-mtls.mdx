---
sidebar_position: 4
title: Deploy mTLS between pods
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# mTLS

This tutorial will walk you through deploying mTLS certificates on a sample client-server deployment.
We will:

- Install Otterize
- Learn how to annotate pods for automatic credentials generation
- Deploy client and server pods communicating over HTTPS and provision credentials to them
- Inspect the credentials


## Install Otterize
:::note
You can skip this section if Otterize is already installed in your cluster.
:::
{@include: ../_common/install-otterize.md}


## Deploy the example

Our example consists of two pods: client and server communicating over HTTPS using credentials
provisioned by the Otterize SPIRE integration operator.

<details>
<summary>Expand to see the details of this example</summary>
<Tabs>

<TabItem value="namespace.yaml" label="namespace.yaml" default>

   ```yaml
   {@include: ../../static/code-examples/kafka-mtls/namespace.yaml}
   ```

</TabItem>

<TabItem value="client-deployment.yaml" label="client-deployment.yaml">

   ```yaml
  {@include: ../../static/code-examples/kafka-mtls/client-deployment.yaml}
  ```

</TabItem>

<TabItem value="client-configmap.yaml" label="client-configmap.yaml">

   ```yaml
  {@include: ../../static/code-examples/kafka-mtls/client-configmap.yaml}
  ```

</TabItem>
<TabItem value="client.js" label="client.js" default>

   ```js
   const fs = require('fs');
const https = require('https');

const options = {
    hostname: 'server.otterize-tutorial-mtls',
    port: 443,
    path: '/hello',
    method: 'GET',
    cert: fs.readFileSync('/var/otterize/credentials/svid.pem'),
    key: fs.readFileSync('/var/otterize/credentials/key.pem'),
    ca: fs.readFileSync('/var/otterize/credentials/bundle.pem')
}

const req = https.request(
    options,
    res => {
        res.on('data', function (data) {
            console.log(data.toString())
        });
    }
);

req.end();
   ```

</TabItem>
<TabItem value="server.js" label="server.js" default>

   ```js
const https = require(`https`);
const fs = require(`fs`);

const options = {
  key: fs.readFileSync('/var/otterize/credentials/key.pem'),
  cert: fs.readFileSync('/var/otterize/credentials/svid.pem'),
  ca: fs.readFileSync('/var/otterize/credentials/bundle.pem'),
  requestCert: true
};

https.createServer(
    options,
    (req, res) => {
        const peerCert = req.connection.getPeerCertificate();
        const ownCert = req.connection.getCertificate();
        console.log("Received request:");
        console.log(peerCert.subject.CN + ":\t" + req.method + " " + req.url);
        if (req.url === '/hello') {
            res.writeHead(200);
            res.end('mTLS hello world\nfrom: ' + ownCert.subject.CN + '\nto client: ' + peerCert.subject.CN);
        } else {
            res.end();
        }
    }).listen(443);
   ```

</TabItem>
</Tabs>
</details>


For credentials to be generated for a pod, it must be annotated to inform the SPIRE integration operator of the desired secret name.

We'll be performing the following steps:
1. Annotate the pod - Otterize looks for the `otterize/credentials-secret-name` annotation, generates
mTLS credentials, and stores them as K8s secret named as the annotation value.
2. Mount the credentials stored as a K8s secret as a volume
3. Mount the volume into the container

<details>
<summary>Expand to see a detailed explanation for the configuration deployed below</summary>

```yaml
spec:
  template:
    metadata:
      ...
      annotations:
        # highlight-next-line
        otterize/credentials-secret-name: client-credentials-secret       # 1 Generate credentials
    spec:
      volumes:
        # highlight-start
        - name: otterize-credentials
          secret:
            secretName: client-credentials-secret                         # 2 Mount credentials as a volume
            # highlight-end
      containers:
        - name: client
        ...
        volumeMounts:
          # highlight-start
          - name: otterize-credentials
            mountPath: /var/otterize/credentials                          # 3 Mount volume into container
            readOnly: true
            # highlight-end
```
</details>




1. Deploy the `client` and `server` using `kubectl`.
   ```bash
   kubectl apply -f https://docs.otterize.com/code-examples/mtls/all.yaml
   ```

<details>
<summary>Optional: check deployment status</summary>

```bash
kubectl get pods -n otterize-tutorial-mtls
```
You should see
```
NAME                      READY   STATUS    RESTARTS   AGE
client-5689997b5c-grlnt   1/1     Running   0          35s
server-6698c58cbc-v9n9b   1/1     Running   0          34s
```
</details>

## Watch it in action

1. Confirm that the client can successfully call the server using HTTP over mTLS. The client makes requests, and the server replies
   with the server's certificate's `common name` as well as the `client`'s certificate `common name`.

   ```bash
   kubectl logs --tail 3 -n otterize-tutorial-mtls deploy/client
   ```

   You should see the following line:

   ```shell
   mTLS hello world
   from: server.otterize-tutorial-mtls          # server's common name in the certificate
   to client: client.otterize-tutorial-mtls     # client's common name in the certificate
   ```
2. You can also follow the server's output log with:
   ```bash
   kubectl logs --tail 1 -n otterize-tutorial-mtls deploy/server
   ```

   You should see the following output:

   ```shell
   client.otterize-tutorial-mtls:  GET /hello
   ```

## Inspect credentials

We can use openssl to inspect the generated credentials. The credentials are stored as a K8s secret and are then mounted as a file into the container.

1.
   To retrieve the credentials from the K8s secret, run the following:

   ```shell
   kubectl get secret -n otterize-tutorial-mtls client-credentials-secret -o jsonpath='{.data.svid\.pem}' | base64 -d > svid.pem
   ```

2. And then inspect them with:

   ```shell
   openssl x509 -in svid.pem -text | head -n 15
   ```
   You should see output similar to:
   ```x509
   Certificate:
       Data:
           Version: 3 (0x2)
           Serial Number:
               0b:eb:eb:4d:0e:02:7e:28:93:30:1c:55:26:22:8b:c7
           Signature Algorithm: sha256WithRSAEncryption
           Issuer: C = US, O = SPIRE
           Validity
               Not Before: Aug 24 12:19:57 2022 GMT
               Not After : Sep 23 12:20:07 2022 GMT
   # highlight-next-line
           Subject: C = US, O = SPIRE, CN = client.otterize-tutorial-mtls       # the client's name
           Subject Public Key Info:
               Public Key Algorithm: id-ecPublicKey
                   Public-Key: (256 bit)
                   pub:
   ```

3. You can see that Otterize generated an X.509 keypair using the pod's name `client` and namespace `otterize-tutorial-mtls`: `client.otterize-tutorial-mtls`.
   The certificate belongs to a chain of trust starting at the SPIRE server.

<details>
<summary>Expand to see what happened behind the scenes</summary>

1. We annotated the pods to let Otterize know it should generate mTLS credentials.
2. The Otterize SPIRE integration operator
    1. Created an entries for the annotated pods with the SPIRE server.
    2. Generated matching mTLS credentials using the SPIRE server.
    3. Stored the mTLS credentials into a K8s secret.
3. The secrets were mounted (separately) into each pod's container.
4. The pods communicated with each other using mutual TLS-authenticated HTTPS.

</details>

:::note
Otterize defaults to generating credentials with an expiry time of 1 day. The certificates are
automatically refreshed before expiring, and therefore you must always read the credentials from file rather than caching them.

To set a longer expiration time, set the `spire-integration.otterize.com/cert-ttl` annotation for your pods. FIXME For more information, see the documentation for the [SPIRE integration operator](/components/spire-integration-operator)
:::

## What's next

<!--
FIXME: Missing documentation
- Read about how to [integrate](/sdk-integration/credential-sdk-integration) mTLS into common SDKs and
  frameworks.
--->
- Enforce [secure Kafka access](/quick-tutorials/kafka-mtls) with mTLS.

## Teardown

To remove the deployed resources run:

```bash
kubectl delete -f https://docs.otterize.com/code-examples/mtls/all.yaml
```
