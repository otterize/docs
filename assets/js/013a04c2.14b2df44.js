"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1601],{5680:(e,t,a)=>{a.d(t,{xA:()=>c,yg:()=>m});var n=a(6540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},g=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(a),g=r,m=d["".concat(s,".").concat(g)]||d[g]||p[g]||o;return a?n.createElement(m,i(i({ref:t},c),{},{components:a})):n.createElement(m,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=g;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=a[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}g.displayName="MDXCreateElement"},9610:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var n=a(8168),r=(a(6540),a(5680));const o={sidebar_position:2,title:"Automate Azure IAM for AKS",image:"/img/quick-tutorials/azure-iam-aks/social.png"},i=void 0,l={unversionedId:"features/azure-iam/tutorials/azure-iam-aks",id:"features/azure-iam/tutorials/azure-iam-aks",title:"Automate Azure IAM for AKS",description:"Otterize automates Azure IAM identities and role assignments for your Azure AKS workloads, all in Kubernetes.",source:"@site/docs/features/azure-iam/tutorials/azure-iam-aks.mdx",sourceDirName:"features/azure-iam/tutorials",slug:"/features/azure-iam/tutorials/azure-iam-aks",permalink:"/features/azure-iam/tutorials/azure-iam-aks",draft:!1,editUrl:"https://github.com/otterize/docs/edit/main/docs/features/azure-iam/tutorials/azure-iam-aks.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Automate Azure IAM for AKS",image:"/img/quick-tutorials/azure-iam-aks/social.png"},sidebar:"docSidebar",previous:{title:"Azure IAM | Overview",permalink:"/features/azure-iam/"},next:{title:"Reference",permalink:"/features/azure-iam/reference"}},s={},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"1. Install the Azure CLI",id:"1-install-the-azure-cli",level:3},{value:"2. Create an Azure AKS cluster",id:"2-create-an-azure-aks-cluster",level:3},{value:"2. Deploy Otterize for Azure IAM",id:"2-deploy-otterize-for-azure-iam",level:3},{value:"Tutorial",id:"tutorial",level:2},{value:"Create an Azure Blob Storage account &amp; container",id:"create-an-azure-blob-storage-account--container",level:3},{value:"Deploy the sample client",id:"deploy-the-sample-client",level:3},{value:"View logs for the client - Azure client ID not set",id:"view-logs-for-the-client---azure-client-id-not-set",level:4},{value:"Label the client pod to create an Azure workload identity",id:"label-the-client-pod-to-create-an-azure-workload-identity",level:3},{value:"An Azure workload identity was created for the client pod",id:"an-azure-workload-identity-was-created-for-the-client-pod",level:4},{value:"The Kubernetes ServiceAccount was annotated with the workload identity ID",id:"the-kubernetes-serviceaccount-was-annotated-with-the-workload-identity-id",level:4},{value:"View logs for the client - Azure client ID is set, but no subscriptions found",id:"view-logs-for-the-client---azure-client-id-is-set-but-no-subscriptions-found",level:4},{value:"Apply intents to create the necessary IAM role assignments",id:"apply-intents-to-create-the-necessary-iam-role-assignments",level:3},{value:"The client can now download files from the Azure Blob Storage container!",id:"the-client-can-now-download-files-from-the-azure-blob-storage-container",level:3},{value:"What&#39;s next?",id:"whats-next",level:3},{value:"Teardown",id:"teardown",level:2}],c={toc:u},d="wrapper";function p(e){let{components:t,...o}=e;return(0,r.yg)(d,(0,n.A)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"Otterize automates Azure IAM identities and role assignments for your Azure AKS workloads, all in Kubernetes."),(0,r.yg)("p",null,"In this tutorial, we will:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Optionally, spin up an AKS cluster, install the Otterize Kubernetes operator on it, and configure it to manage Azure IAM."),(0,r.yg)("li",{parentName:"ul"},"Deploy a client pod that downloads file from one blob container, and upload them to another."),(0,r.yg)("li",{parentName:"ul"},"Label the client pod, telling the credentials operator to link its Kubernetes ServiceAccount with an Azure workload identity created for it."),(0,r.yg)("li",{parentName:"ul"},"See attempted operation to Azure Blob Storage."),(0,r.yg)("li",{parentName:"ul"},"Create a ",(0,r.yg)("inlineCode",{parentName:"li"},"ClientIntents")," resource allowing the client pod to access Azure Blob Storage, that tells the intents operator to create a role assignment and associate it with the previously created workload identity."),(0,r.yg)("li",{parentName:"ul"},"See that the client is now able to list files in the Azure Blob Storage container.")),(0,r.yg)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.yg)("p",null,"Already have Otterize deployed with the Azure IAM integration configured on your cluster? ",(0,r.yg)("a",{parentName:"p",href:"#tutorial"},"Skip to the tutorial.")),(0,r.yg)("h3",{id:"1-install-the-azure-cli"},"1. Install the Azure CLI"),(0,r.yg)("p",null,"Follow the installation instructions for the ",(0,r.yg)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"},"Azure CLI"),"."),(0,r.yg)("h3",{id:"2-create-an-azure-aks-cluster"},"2. Create an Azure AKS cluster"),(0,r.yg)("p",null,"Before you start, you'll need an Azure AKS cluster, with OIDC issuer & workload identity enabled."),(0,r.yg)("details",null,(0,r.yg)("summary",null,"How to set up an Azure AKS cluster using the Azure CLI"),(0,r.yg)("p",null,"Export the following environment variables:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'export LOCATION="eastus"\nexport RESOURCE_GROUP="otterizeAzureIAMTutorialResourceGroup"\nexport AKS_CLUSTER_NAME="otterizeAzureIAMTutorialAKSCluster"\n')),(0,r.yg)("p",null,"Create a resource group:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az group create --name $RESOURCE_GROUP --location $LOCATION\n")),(0,r.yg)("p",null,"Create an AKS cluster, with OIDC issuer and workload identity enabled:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az aks create -g $RESOURCE_GROUP -n $AKS_CLUSTER_NAME --node-count 1 --enable-oidc-issuer --enable-workload-identity --generate-ssh-keys\n"))),(0,r.yg)("p",null,"Alternatively, update an existing AKS cluster to enable OIDC issuer and workload identity:"),(0,r.yg)("details",null,(0,r.yg)("summary",null,"How to update an existing AKS cluster using the Azure CLI"),(0,r.yg)("p",null,"Export the following environment variables:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'export LOCATION="<YOUR_LOCATION>"\nexport RESOURCE_GROUP="<YOUR_RESOURCE_GROUP>"\nexport AKS_CLUSTER_NAME="<YOUR_AKS_CLUSTER_NAME>"\n')),(0,r.yg)("p",null,"Update the AKS cluster to enable OIDC issuer and workload identity:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az aks update -g $RESOURCE_GROUP -n $AKS_CLUSTER_NAME --enable-oidc-issuer --enable-workload-identity\n"))),(0,r.yg)("p",null,"Don't forget to configure your kubeconfig for your cluster. If using the example cluster above, use this command:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az aks get-credentials -n $AKS_CLUSTER_NAME -g $RESOURCE_GROUP\n")),(0,r.yg)("h3",{id:"2-deploy-otterize-for-azure-iam"},"2. Deploy Otterize for Azure IAM"),(0,r.yg)("p",null,"To deploy Otterize, head over to ",(0,r.yg)("a",{parentName:"p",href:"https://app.otterize.com"},"Otterize Cloud")," and:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"Create a Kubernetes integration on the ",(0,r.yg)("a",{parentName:"li",href:"https://app.otterize.com/integrations"},"Integrations page"),", and follow the instructions. ",(0,r.yg)("em",{parentName:"li"},"Make sure to enable enforcement mode for this tutorial.")," If you already have a Kubernetes cluster connected, skip this step.",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"You will first need to install Otterize in your cluster. If your cluster is not already connected, you can do so by following the Kubernetes setup instructions detailed on the ",(0,r.yg)("a",{parentName:"li",href:"https://app.otterize.com/integrations"},"Integrations")," page.")))),(0,r.yg)("admonition",{title:"Important",type:"info"},(0,r.yg)("p",{parentName:"admonition"},"When installing Otterize, append the following flag to the Helm command to enable the eBPF agent, which is responsible for inspecting SSL and non-SSL traffic and generates the visibility into Azure traffic:")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"helm upgrade ... --set networkMapper.nodeagent.enable=true\n")),(0,r.yg)("ol",{start:2},(0,r.yg)("li",{parentName:"ol"},"Create an Azure IAM integration on the ",(0,r.yg)("a",{parentName:"li",href:"https://app.otterize.com/integrations"},"Integrations page"),".",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Input your Azure tenant & subscription IDs. These are available in the Azure portal, or by running the following command:",(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az account list --output table\n"))),(0,r.yg)("li",{parentName:"ul"},"If you are using the cluster from the previous step, the resource group name is ",(0,r.yg)("inlineCode",{parentName:"li"},"otterizeAzureIAMTutorialResourceGroup")," and the cluster name is ",(0,r.yg)("inlineCode",{parentName:"li"},"otterizeAzureIAMTutorialAKSCluster"),".")))),(0,r.yg)("p",null,"Once the Azure integration is configured, you'll be presented with instructions for configuring your Otterize integration with Azure IAM support.\nThis creates a managed identity and federated identity credential for the Otterize Kubernetes operator, and assigns it the resource group owner role on the resource group containing your AKS cluster, so that it is able to manage identitiies and role assignments for your AKS workloads.\nThis setup is required once per-cluster."),(0,r.yg)("p",null,"After Terraform has configured your cluster, click Next and you'll be presented with the configuration for deploying Otterize.\nSince you now have the Azure integration enabled, you need to redeploy Otterize with Azure integration enabled flag, providing it the client ID for the managed identity created during the terraform installation."),(0,r.yg)("h2",{id:"tutorial"},"Tutorial"),(0,r.yg)("h3",{id:"create-an-azure-blob-storage-account--container"},"Create an Azure Blob Storage account & container"),(0,r.yg)("p",null,"Create a general-purpose storage account using the Azure CLI:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"export STORAGE_ACCOUNT_NAME=ottrtutorial`date +%s`\naz storage account create \\\n  --name $STORAGE_ACCOUNT_NAME \\\n  --resource-group $RESOURCE_GROUP\n")),(0,r.yg)("p",null,"Create an ",(0,r.yg)("inlineCode",{parentName:"p"},"uploads")," container in the storage account:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az storage container create \\\n    --account-name $STORAGE_ACCOUNT_NAME \\\n    --name uploads\n")),(0,r.yg)("p",null,"Create a ",(0,r.yg)("inlineCode",{parentName:"p"},"downloads")," container in the storage account:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az storage container create \\\n    --account-name $STORAGE_ACCOUNT_NAME \\\n    --name downloads\n")),(0,r.yg)("p",null,"Upload a blob to the ",(0,r.yg)("inlineCode",{parentName:"p"},"downloads")," container:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'echo "Hello, Azure integration" > hello.txt\naz storage blob upload \\\n    --account-name $STORAGE_ACCOUNT_NAME \\\n    --container-name downloads \\\n    --file hello.txt \\\n    --name hello.txt\n')),(0,r.yg)("h3",{id:"deploy-the-sample-client"},"Deploy the sample client"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'kubectl apply -f ${ABSOLUTE_URL}/code-examples/azure-iam-aks/client.yaml\nkubectl patch -n otterize-tutorial-azure-iam deployment/client --type=\'json\' -p="[{\\"op\\": \\"replace\\", \\"path\\": \\"/spec/template/spec/containers/0/env\\", \\"value\\": [{\\"name\\": \\"STORAGE_ACCOUNT_NAME\\", \\"value\\": \\"$STORAGE_ACCOUNT_NAME\\"}]}]"\n')),(0,r.yg)("details",null,(0,r.yg)("summary",null,"Expand to see the deployment YAML"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: otterize-tutorial-azure-iam\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: client\n  namespace: otterize-tutorial-azure-iam\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: client\n  namespace: otterize-tutorial-azure-iam\nspec:\n  selector:\n    matchLabels:\n      app: client\n  template:\n    metadata:\n      labels:\n        app: client\n        # Required by the Azure workload identity operator, only the pods with this label can use workload identity\n        azure.workload.identity/use: "true"\n    spec:\n      serviceAccountName: client\n      containers:\n        - name: client\n          image: mcr.microsoft.com/azure-cli\n          command: [ "/bin/sh", "-c", "--" ]\n          env:\n            - name: STORAGE_ACCOUNT_NAME\n              value: ottrazuredemo\n          args:\n            - while true;\n              do\n                echo;\n                echo \'Client - The time is:\' $(date);\n                echo;\n                if [[ -z "$AZURE_CLIENT_ID" ]]; then echo "Azure client ID not set";\n                else\n                  echo \'Logging in using federated identity credentials\';\n                  az login -o table --federated-token $(cat $AZURE_FEDERATED_TOKEN_FILE) --service-principal -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID;\n                  echo;\n                  echo \'Downloading file from storage blob container downloads in storage account\' $STORAGE_ACCOUNT_NAME;\n                  az storage blob download --account-name $STORAGE_ACCOUNT_NAME -c downloads -n hello.txt --auth-mode login -o table;\n                  echo \'Uploading file to storage blob container uploads in storage account\' $STORAGE_ACCOUNT_NAME;\n                  az storage blob upload --account-name $STORAGE_ACCOUNT_NAME --container-name uploads -n hello.txt --data "hello"  --overwrite --auth-mode login -o table;\n                  echo;\n                fi;\n                sleep 5;\n              done\n\n'))),(0,r.yg)("h4",{id:"view-logs-for-the-client---azure-client-id-not-set"},"View logs for the client - Azure client ID not set"),(0,r.yg)("p",null,"The client logs will show that the Azure client ID environment variable is not set.\nThis is because no Azure workload identity has been created for the client pod yet."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -f -n otterize-tutorial-azure-iam deploy/client\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-text"},"Client - The time is: Sun Mar 10 18:40:37 UTC 2024\n\nAzure client ID not set\n")),(0,r.yg)("h3",{id:"label-the-client-pod-to-create-an-azure-workload-identity"},"Label the client pod to create an Azure workload identity"),(0,r.yg)("p",null,"Label the client pod so that the Otterize credentials operator creates an Azure workload identity for it and binds its Kubernetes ServiceAccount to the newly created identity:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'kubectl patch -n otterize-tutorial-azure-iam deployment/client -p \'{"spec": {"template":{"metadata":{"labels":{"credentials-operator.otterize.com/create-azure-workload-identity":"true"}}}} }\'\n')),(0,r.yg)("p",null,"This applies the following label to the client pod:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},'metadata:\n  labels:\n    credentials-operator.otterize.com/create-azure-workload-identity: "true"\n')),(0,r.yg)("h4",{id:"an-azure-workload-identity-was-created-for-the-client-pod"},"An Azure workload identity was created for the client pod"),(0,r.yg)("p",null,"Let's inspect the created managed identity"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az identity list --query \"[?starts_with(name,'ottr-uai-')]\" --resource-group $RESOURCE_GROUP --output table\n")),(0,r.yg)("p",null,"In the output, you should see that a managed identity was created for the client workload, with the name starting with ",(0,r.yg)("inlineCode",{parentName:"p"},"ottr-uai-otterize-tutorial-azure-iam-client-..."),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"Name                                                                                  Location    TenantId                              PrincipalId                           ClientId                              ResourceGroup\n------------------------------------------------------------------------------------  ----------  ------------------------------------  ------------------------------------  ------------------------------------  ---------------------------------\nottr-uai-otterize-tutorial-azure-iam-client-otterizeAzureIAMTutorialAKSCluster-XXXXX  eastus      00000000-0000-0000-0000-000000000000  00000000-0000-0000-0000-000000000000  00000000-0000-0000-0000-000000000000  otterizeAzureIAMTutorialResourceGroup\n")),(0,r.yg)("p",null,"You could also inspect the federated identity credential created for the client workload:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'export WORKLOAD_IDENTITY_NAME=$(az identity list --query "[?starts_with(name,\'ottr-uai-otterize-tutorial-azure-iam-client-$AKS_CLUSTER_NAME\')].name" --resource-group $RESOURCE_GROUP  -o tsv)\naz identity federated-credential list --identity-name $WORKLOAD_IDENTITY_NAME --resource-group $RESOURCE_GROUP --output table --query "[].{name:name, subject:subject}"\n')),(0,r.yg)("p",null,"In the output, you should see that a federated identity credential was created for the client workload:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"Name                                                                                  Subject\n------------------------------------------------------------------------------------  --------------------------------------------------------\nottr-fic-otterize-tutorial-azure-iam-client-otterizeAzureIAMTutorialAKSCluster-XXXXX  system:serviceaccount:otterize-tutorial-azure-iam:client\n")),(0,r.yg)("h4",{id:"the-kubernetes-serviceaccount-was-annotated-with-the-workload-identity-id"},"The Kubernetes ServiceAccount was annotated with the workload identity ID"),(0,r.yg)("p",null,"The credentials operator automatically annotated the Kubernetes ServiceAccount for the client pod with the newly created workload identity"),(0,r.yg)("p",null,"Let's look at the service account:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"kubectl get serviceaccount -n otterize-tutorial-azure-iam client -o yaml\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    # highlight-next-line\n    azure.workload.identity/client-id: 6fda2902-d98c-40f6-800d-29d5856e359a\n  name: client\n  namespace: otterize-tutorial-azure-iam\n")),(0,r.yg)("h4",{id:"view-logs-for-the-client---azure-client-id-is-set-but-no-subscriptions-found"},"View logs for the client - Azure client ID is set, but no subscriptions found"),(0,r.yg)("p",null,"The client logs will now show that the Azure client ID environment variable is set,\nand the client attempts to log in using federated identity credentials.\nHowever, the client is still unable to login or access any Azure resources,\nas no Azure IAM role assignments have been created for the client workload identity yet."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"kubectl logs -f -n otterize-tutorial-azure-iam deploy/client\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-text"},"Logging in using federated identity credentials\nERROR: No subscriptions found for 00000000-0000-0000-0000-000000000000\n\nListing storage blob container ottrtutorialcontainer in storage account ottrtutorial\nERROR: Please run 'az login' to setup account.\n")),(0,r.yg)("h3",{id:"apply-intents-to-create-the-necessary-iam-role-assignments"},"Apply intents to create the necessary IAM role assignments"),(0,r.yg)("p",null,"By annotating the pod, we've created a workload identity.\nWe now need to specify what we need to access, and the intents operator will create an Azure IAM role assignment accordingly."),(0,r.yg)("p",null,"To do so, we will apply a ",(0,r.yg)("inlineCode",{parentName:"p"},"ClientIntents")," resource that permits the client pod to download files from the source container:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},'kubectl apply -n otterize-tutorial-azure-iam -f ${ABSOLUTE_URL}/code-examples/azure-iam-aks/clientintents-1.yaml\nkubectl patch -n otterize-tutorial-azure-iam clientintents/client-intents-for-client  --type=\'json\' -p="[{\\"op\\": \\"replace\\", \\"path\\": \\"/spec/calls/0/name\\", \\"value\\": \\"/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME/blobServices/default/containers/downloads\\"}]"\n')),(0,r.yg)("p",null,"This applies the following ClientIntents, granting read access to the ",(0,r.yg)("inlineCode",{parentName:"p"},"downloads")," container in the storage account:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v2alpha1\nkind: ClientIntents\nmetadata:\n  name: client-intents-for-client\n  namespace: otterize-tutorial-azure-iam\nspec:\n  workload:\n    name: client\n    kind: Deployment\n  targets:\n    - azure:\n        scope: /providers/Microsoft.Storage/storageAccounts/STORAGE_ACCOUNT_NAME/blobServices/default/containers/downloads\n        dataActions:\n          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read\n")),(0,r.yg)("h3",{id:"the-client-can-now-download-files-from-the-azure-blob-storage-container"},"The client can now download files from the Azure Blob Storage container!"),(0,r.yg)("p",null,"Let's look at the client logs again:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -f -n otterize-tutorial-azure-iam deploy/client\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-text"},'Client - The time is: Sun Mar 10 18:53:24 UTC 2024\n\nLogging in using federated identity credentials\nCloudName    HomeTenantId                          IsDefault    Name                  State    TenantId\n-----------  ------------------------------------  -----------  --------------------  -------  ------------------------------------\nAzureCloud   00000000-0000-0000-0000-000000000000  True         Azure subscription 1  Enabled  00000000-0000-0000-0000-000000000000\n\nDownloading file from storage blob container downloads in storage account ottrtutorial1735147968\n Hello, Azure integration                                                                                                                        \u2502\nAlive[################################################################]  100.0000%Finished[#################################################### \u2502\nUploading file to storage blob container uploads in storage account ottrtutorial1735147968                                                      \u2502\nERROR:                                                                                                                                          \u2502\nYou do not have the required permissions needed to perform this operation.                                                                      \u2502\nDepending on your operation, you may need to be assigned one of the following roles:                                                            \u2502\n    "Storage Blob Data Owner"                                                                                                                   \u2502\n    "Storage Blob Data Contributor"                                                                                                             \u2502\n    "Storage Blob Data Reader"                                                                                                                  \u2502\n    "Storage Queue Data Contributor"                                                                                                            \u2502\n    "Storage Queue Data Reader"                                                                                                                 \u2502\n    "Storage Table Data Contributor"                                                                                                            \u2502\n    "Storage Table Data Reader"\n')),(0,r.yg)("p",null,"The file is successfully downloaded from the ",(0,r.yg)("inlineCode",{parentName:"p"},"downloads")," container, but the client fails to upload it to the ",(0,r.yg)("inlineCode",{parentName:"p"},"uploads")," container. This is because some permissions are still missing. Let's take a look at the access graph at ",(0,r.yg)("a",{parentName:"p",href:"https://app.otterize.com"},"Otterize Cloud"),": "),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Access Graph",src:a(6273).A,width:"1476",height:"1066"})),(0,r.yg)("p",null,"The access graph visualizes the applied ClientIntents in green, while the newly discovered intents, which are still missing permissions, are shown in yellow. "),(0,r.yg)("p",null,"By clicking on the ",(0,r.yg)("inlineCode",{parentName:"p"},"client")," node, you can view and download the full set of ClientIntents required for it to access both buckets: "),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Client Intents",src:a(2073).A,width:"1142",height:"1628"})),(0,r.yg)("p",null,"Use the otterize CLI to download and apply the intents to the cluster:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"otterize clientintents export -n otterize-tutorial-azure-iam -v v2 | kubectl apply -f-\n")),(0,r.yg)("p",null,"Complete ClientIntents file:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v2alpha1\nkind: ClientIntents\nmetadata:\n  name: client-intents-for-client\n  namespace: otterize-tutorial-azure-iam\nspec:\n  workload:\n    name: client\n    kind: Deployment\n  targets:\n    - azure:\n        scope: /providers/Microsoft.Storage/storageAccounts/STORAGE_ACCOUNT_NAME/blobServices/default/containers/downloads\n        dataActions:\n          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read\n    - azure:\n        scope: /providers/Microsoft.Storage/storageAccounts/STORAGE_ACCOUNT_NAME/blobServices/default/containers/uploads\n        dataActions:\n          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/add/action\n          - Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write\n\n")),(0,r.yg)("admonition",{type:"note"},(0,r.yg)("p",{parentName:"admonition"},"Azure role assignments may take up to 10 minutes to take effect. This is a known limitation of Azure RBAC.\nIf you are still seeing access errors in the client logs, wait a few minutes and try again.")),(0,r.yg)("h3",{id:"whats-next"},"What's next?"),(0,r.yg)("p",null,"Try out some of the other quick tutorials to learn about how to use ClientIntents to manage network policies, Istio policies, PostgreSQL access, and more. You can use a single ClientIntents resource to specify all the access required for a pod."),(0,r.yg)("h2",{id:"teardown"},"Teardown"),(0,r.yg)("p",null,"To remove the deployed examples run:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"kubectl delete namespace otterize-tutorial-azure-iam\n")),(0,r.yg)("p",null,"To delete the Azure blob storage account & container:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az storage account delete --name $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP\n")),(0,r.yg)("p",null,"To delete the cluster, if you created the one in this tutorial:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"az aks delete --name $AKS_CLUSTER_NAME --resource-group $RESOURCE_GROUP\n")))}p.isMDXComponent=!0},6273:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/accessgraph-5f2feebf8a0e0572d77b1e93eab35793.png"},2073:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/clientintents-66f8c9ff2db8bb9feb871e7721075e8e.png"}}]);