"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3482,7918],{5162:(e,t,n)=>{n.d(t,{Z:()=>l});var o=n(7294),a=n(6010);const r={tabItem:"tabItem_Ymn6"};function l(e){let{children:t,hidden:n,className:l}=e;return o.createElement("div",{role:"tabpanel",className:(0,a.Z)(r.tabItem,l),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>y});var o=n(7462),a=n(7294),r=n(6010),l=n(2466),i=n(6550),s=n(1980),c=n(7392),d=n(12);function p(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:o,default:a}}=e;return{value:t,label:n,attributes:o,default:a}}))}function u(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,c.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const o=(0,i.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s._X)(r),(0,a.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(o.location.search);t.set(r,e),o.replace({...o.location,search:t.toString()})}),[r,o])]}function k(e){const{defaultValue:t,queryString:n=!1,groupId:o}=e,r=u(e),[l,i]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const o=n.find((e=>e.default))??n[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:t,tabValues:r}))),[s,c]=h({queryString:n,groupId:o}),[p,k]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[o,r]=(0,d.Nk)(n);return[o,(0,a.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:o}),g=(()=>{const e=s??p;return m({value:e,tabValues:r})?e:null})();(0,a.useLayoutEffect)((()=>{g&&i(g)}),[g]);return{selectedValue:l,selectValue:(0,a.useCallback)((e=>{if(!m({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);i(e),c(e),k(e)}),[c,k,r]),tabValues:r}}var g=n(2389);const v={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function f(e){let{className:t,block:n,selectedValue:i,selectValue:s,tabValues:c}=e;const d=[],{blockElementScrollPositionUntilNextRender:p}=(0,l.o5)(),u=e=>{const t=e.currentTarget,n=d.indexOf(t),o=c[n].value;o!==i&&(p(t),s(o))},m=e=>{let t=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const n=d.indexOf(e.currentTarget)+1;t=d[n]??d[0];break}case"ArrowLeft":{const n=d.indexOf(e.currentTarget)-1;t=d[n]??d[d.length-1];break}}t?.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},c.map((e=>{let{value:t,label:n,attributes:l}=e;return a.createElement("li",(0,o.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:e=>d.push(e),onKeyDown:m,onClick:u},l,{className:(0,r.Z)("tabs__item",v.tabItem,l?.className,{"tabs__item--active":i===t})}),n??t)})))}function w(e){let{lazy:t,children:n,selectedValue:o}=e;const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=r.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},r.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==o}))))}function b(e){const t=k(e);return a.createElement("div",{className:(0,r.Z)("tabs-container",v.tabList)},a.createElement(f,(0,o.Z)({},e,t)),a.createElement(w,(0,o.Z)({},e,t)))}function y(e){const t=(0,g.Z)();return a.createElement(b,(0,o.Z)({key:String(t)},e))}},3155:(e,t,n)=>{n.d(t,{Z:()=>L});var o=n(7462),a=n(7294),r=n(2389),l=n(6010),i=n(6412),s=n(5281),c=n(7016);const d={codeBlockContainer:"codeBlockContainer_APcc"};function p(e){let{as:t,...n}=e;const r=(0,i.p)(),p=(0,c.QC)(r);return a.createElement(t,(0,o.Z)({},n,{style:p,className:(0,l.Z)(n.className,d.codeBlockContainer,s.k.common.codeBlock)}))}const u={codeBlockContent:"codeBlockContent_m3Ux",codeBlockTitle:"codeBlockTitle_P25_",codeBlock:"codeBlock_qGQc",codeBlockStandalone:"codeBlockStandalone_zC50",codeBlockLines:"codeBlockLines_p187",codeBlockLinesWithNumbering:"codeBlockLinesWithNumbering_OFgW",buttonGroup:"buttonGroup_6DOT"};function m(e){let{children:t,className:n}=e;return a.createElement(p,{as:"pre",tabIndex:0,className:(0,l.Z)(u.codeBlockStandalone,"thin-scrollbar",n)},a.createElement("code",{className:u.codeBlockLines},t))}var h=n(6668),k=n(5448),g=n(3746);const v={codeLine:"codeLine_iPqp",codeLineNumber:"codeLineNumber_F4P7",codeLineContent:"codeLineContent_pOih"};var f=n(4996);function w(e){let{line:t,classNames:n,showLineNumbers:r,getLineProps:i,getTokenProps:s}=e;1===t.length&&"\n"===t[0].content&&(t[0].content="");const c=i({line:t,className:(0,l.Z)(n,r&&v.codeLine)}),d=t.map(((e,t)=>a.createElement("span",(0,o.Z)({key:t},s({token:e,key:t})))));return a.createElement("span",c,r?a.createElement(a.Fragment,null,a.createElement("span",{className:v.codeLineNumber}),a.createElement("span",{className:v.codeLineContent},d)):d,a.createElement("br",null))}var b=n(195),y=n(5999),N=n(345),C=n(7666);const T={copyButtonCopied:"copyButtonCopied__QnY",copyButtonIcons:"copyButtonIcons_FhaS",copyButtonIcon:"copyButtonIcon_phi_",copyButtonSuccessIcon:"copyButtonSuccessIcon_FfTR"};function E(e){let{code:t,className:n}=e;const[o,r]=(0,a.useState)(!1),i=(0,a.useRef)(void 0),s=(0,a.useCallback)((()=>{(0,b.Z)(t),r(!0),i.current=window.setTimeout((()=>{r(!1)}),1e3)}),[t]);return(0,a.useEffect)((()=>()=>window.clearTimeout(i.current)),[]),a.createElement("button",{type:"button","aria-label":o?(0,y.I)({id:"theme.CodeBlock.copied",message:"Copied",description:"The copied button label on code blocks"}):(0,y.I)({id:"theme.CodeBlock.copyButtonAriaLabel",message:"Copy code to clipboard",description:"The ARIA label for copy code blocks button"}),title:(0,y.I)({id:"theme.CodeBlock.copy",message:"Copy",description:"The copy button label on code blocks"}),className:(0,l.Z)("clean-btn",n,T.copyButton,o&&T.copyButtonCopied),onClick:s},a.createElement("span",{className:T.copyButtonIcons,"aria-hidden":"true"},a.createElement(N.Z,{className:T.copyButtonIcon}),a.createElement(C.Z,{className:T.copyButtonSuccessIcon})))}var I=n(670);const A={wordWrapButtonIcon:"wordWrapButtonIcon_iowe",wordWrapButtonEnabled:"wordWrapButtonEnabled_gY8A"};function z(e){let{className:t,onClick:n,isEnabled:o}=e;const r=(0,y.I)({id:"theme.CodeBlock.wordWrapToggle",message:"Toggle word wrap",description:"The title attribute for toggle word wrapping button of code block lines"});return a.createElement("button",{type:"button",onClick:n,className:(0,l.Z)("clean-btn",t,o&&A.wordWrapButtonEnabled),"aria-label":r,title:r},a.createElement(I.Z,{className:A.wordWrapButtonIcon,"aria-hidden":"true"}))}function B(e){let{children:t,className:n="",metastring:r,title:s,showLineNumbers:d,language:m}=e;const{prism:{defaultLanguage:v,magicComments:b}}=(0,h.L)(),y=m??(0,c.Vo)(n)??v,N=(0,i.p)(),C=(0,k.F)(),T=(0,c.bc)(r)||s,{lineClassNames:I,code:A}=(0,c.nZ)(t,{metastring:r,language:y,magicComments:b}),B=(0,f.Z)("/",{absolute:!0}).slice(0,-1),L=A.replaceAll("${ABSOLUTE_URL}",B),S=d??(0,c.nt)(r);return a.createElement(p,{as:"div",className:(0,l.Z)(n,y&&!n.includes(`language-${y}`)&&`language-${y}`)},T&&a.createElement("div",{className:u.codeBlockTitle},T),a.createElement("div",{className:u.codeBlockContent},a.createElement(g.ZP,(0,o.Z)({},g.lG,{theme:N,code:L,language:y??"text"}),(e=>{let{className:t,tokens:n,getLineProps:o,getTokenProps:r}=e;return a.createElement("pre",{tabIndex:0,ref:C.codeBlockRef,className:(0,l.Z)(t,u.codeBlock,"thin-scrollbar")},a.createElement("code",{className:(0,l.Z)(u.codeBlockLines,S&&u.codeBlockLinesWithNumbering)},n.map(((e,t)=>a.createElement(w,{key:t,line:e,getLineProps:o,getTokenProps:r,classNames:I[t],showLineNumbers:S})))))})),a.createElement("div",{className:u.buttonGroup},(C.isEnabled||C.isCodeScrollable)&&a.createElement(z,{className:u.codeButton,onClick:()=>C.toggle(),isEnabled:C.isEnabled}),a.createElement(E,{className:u.codeButton,code:L}))))}function L(e){let{children:t,...n}=e;const l=(0,r.Z)(),i=function(e){return a.Children.toArray(e).some((e=>(0,a.isValidElement)(e)))?e:Array.isArray(e)?e.join(""):e}(t),s="string"==typeof i?B:m;return a.createElement(s,(0,o.Z)({key:String(l)},n),i)}},2360:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var o=n(7462),a=(n(7294),n(3905));n(3155),n(4866),n(5162);const r={sidebar_position:1,title:"Protecting a service with network policies"},l=void 0,i={unversionedId:"features/network-mapping-network-policies/tutorials/protect-1-service-network-policies",id:"features/network-mapping-network-policies/tutorials/protect-1-service-network-policies",title:"Protecting a service with network policies",description:"Otterize enables intent-based access control (IBAC).",source:"@site/docs/features/network-mapping-network-policies/tutorials/protect-1-service-network-policies.mdx",sourceDirName:"features/network-mapping-network-policies/tutorials",slug:"/features/network-mapping-network-policies/tutorials/protect-1-service-network-policies",permalink:"/features/network-mapping-network-policies/tutorials/protect-1-service-network-policies",draft:!1,editUrl:"https://github.com/otterize/docs/edit/main/docs/features/network-mapping-network-policies/tutorials/protect-1-service-network-policies.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Protecting a service with network policies"},sidebar:"docSidebar",previous:{title:"NetworkPolicy Automation",permalink:"/features/network-mapping-network-policies/tutorials/k8s-network-policies"},next:{title:"AWS EKS network policies with the VPC CNI",permalink:"/features/network-mapping-network-policies/tutorials/aws-eks-cni-mini"}},s={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Install Otterize on your cluster",id:"install-otterize-on-your-cluster",level:3},{value:"Tutorial",id:"tutorial",level:2},{value:"Deploy the demo set of services",id:"deploy-the-demo-set-of-services",level:3},{value:"Seeing the access graph",id:"seeing-the-access-graph",level:3},{value:"Choose one service to protect",id:"choose-one-service-to-protect",level:3},{value:"Declare client intents",id:"declare-client-intents",level:3},{value:"Protect the <code>productcatalogservice</code>",id:"protect-the-productcatalogservice",level:3},{value:"Ready for production",id:"ready-for-production",level:3},{value:"Will load balancers, ingress, and other external traffic be affected?",id:"will-load-balancers-ingress-and-other-external-traffic-be-affected",level:4},{value:"Will admission webhook controllers, e.g. policy validators like Kyverno, be affected?",id:"will-admission-webhook-controllers-eg-policy-validators-like-kyverno-be-affected",level:4},{value:"Working with Otterize in CI/CD",id:"working-with-otterize-in-cicd",level:4},{value:"In summary",id:"in-summary",level:3},{value:"Teardown",id:"teardown",level:2}],d={toc:c},p="wrapper";function u(e){let{components:t,...r}=e;return(0,a.kt)(p,(0,o.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Otterize enables intent-based access control (IBAC).\nIn this guide, we'll roll out IBAC gradually, protecting just one service, and taking it all the way to production. We'll show how this can be done quickly, safely, and reproducibly:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Choose one service to protect"),'. Until you ensure its intended clients will have access, you\'ll run in "shadow mode": no network policies will actually be created against this server.'),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Declare all its clients' intents")," to call it ","\u2014"," which may be done automatically using the network mapper. See that it would now allow those clients if protection (using network policies) were turned on."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Turn on protection")," for this one service: it is now secure against unintended access."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Take it to production")," by understanding how this would also not break other production-relevant access such as ingress and policy management (e.g. Kyverno), and by putting this into your CI/CD process.")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"The goal is to show you how to realize zero trust, in production, in a matter of hours or days, even if it's just for one or a few services at first. It is that easy.")),(0,a.kt)("p",null,"This guide uses the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/GoogleCloudPlatform/microservices-demo"},"Google microservices demo"),"\n(a simple e-commerce application), deployed to a Kubernetes cluster, for illustration."),(0,a.kt)("p",null,"Note: all the capabilities of IBAC are within Otterize OSS, while the access graph in Otterize Cloud will guide us visually at each step."),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("h3",{id:"install-otterize-on-your-cluster"},"Install Otterize on your cluster"),(0,a.kt)("p",null,"If you do not have a cluster, we will need to prepare one with ",(0,a.kt)("a",{parentName:"p",href:"/overview/installation#create-a-cluster-with-support-for-network-policies"},"network policy support")),(0,a.kt)("p",null,"To deploy Otterize, head over to ",(0,a.kt)("a",{parentName:"p",href:"https://app.otterize.com"},"Otterize Cloud")," and create a Kubernetes cluster on the ",(0,a.kt)("a",{parentName:"p",href:"https://app.otterize.com/clusters"},"Clusters page"),", and follow the instructions."),(0,a.kt)("p",null,"We will also need the ",(0,a.kt)("a",{parentName:"p",href:"/overview/installation#install-the-otterize-cli"},"Otterize CLI"),"."),(0,a.kt)("h2",{id:"tutorial"},"Tutorial"),(0,a.kt)("h3",{id:"deploy-the-demo-set-of-services"},"Deploy the demo set of services"),(0,a.kt)("p",null,"To deploy these into your cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create namespace otterize-ecom-demo\nkubectl apply -n otterize-ecom-demo -f ${ABSOLUTE_URL}/code-examples/shadow-mode/ecom-demo.yaml\n")),(0,a.kt)("details",null,(0,a.kt)("summary",null,(0,a.kt)("em",null,"Optional: check that the demo was deployed.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'To see all the pods in the demo:\n```bash\nkubectl get pods -n otterize-ecom-demo\n```\nThe pods should all be ready and running:\n```bash\nNAME                                     READY   STATUS    RESTARTS      AGE\nadservice-65494cbb9d-5lrv6               1/1     Running   0             115s\ncartservice-6d84fc45bb-hdtwn             1/1     Running   0             115s\ncheckoutservice-5599486df-dvj9n          1/1     Running   3 (79s ago)   115s\ncurrencyservice-6d64686d74-lxb7x         1/1     Running   0             115s\nemailservice-7c6cbfbbd7-xjxlt            1/1     Running   0             115s\nfrontend-f9448d7d4-6dmnr                 1/1     Running   0             115s\nkafka-0                                  1/1     Running   2 (83s ago)   115s\nloadgenerator-7f6987f59-bchgm            1/1     Running   0             114s\norderservice-7ffdbf6df-wzzfd             1/1     Running   0             115s\notterize-ecom-demo-zookeeper-0           1/1     Running   0             115s\npaymentservice-86855d78db-zjjfn          1/1     Running   0             115s\nproductcatalogservice-5944c7f666-2rjc6   1/1     Running   0             115s\nrecommendationservice-6c8d848498-zm2rm   1/1     Running   0             114s\nredis-cart-6b79c5b497-xpms2              1/1     Running   0             115s\nshippingservice-85694cb9bd-v54xp         1/1     Running   0             114s\n```\n\nYou can now browse the web app of this demo, if you wish:\n\n<Tabs groupId="frontend-addr">\n    <TabItem value="k8s" label="K8s">\n\n        To get the externally-accessible URL where your demo front end is available, run:\n        ```bash\n        kubectl get service -n otterize-ecom-demo frontend-external | awk \'{print $4}\'\n        ```\n        The result should be similar to (if running on AWS EKS):\n        ```\n        a11843075fd254f8099a986467098647-1889474685.us-east-1.elb.amazonaws.com\n        ```\n        Go ahead and browse to the URL above to "shop" and get a feel for the demo\'s behavior.\n        (The URL might take some time to populate across DNS servers. Note that we are accessing an HTTP and not an HTTPS website.)\n    </TabItem>\n    <TabItem value="minikube" label="Minikube">\n\n        To get the externally-accessible URL where your demo front end is available, run:\n        ```\n        kubectl port-forward -n otterize-ecom-demo service/frontend-external 8080:80 &\n        ```\n        The demo is now accessible at:\n        ```\n        http://localhost:8080\n        ```\n        Go ahead and browse to the URL above to "shop" and get a feel for the demo\'s behavior.\n    </TabItem>\n</Tabs>\n'))),(0,a.kt)("h3",{id:"seeing-the-access-graph"},"Seeing the access graph"),(0,a.kt)("p",null,"In the Otterize Cloud UI, your ",(0,a.kt)("a",{parentName:"p",href:"https://app.otterize.com/integrations"},"integration")," should now show all 3 Otterize OSS operators ","\u2014"," the network mapper, intents operator, and credentials operator ","\u2014"," as connected, with a green status."),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/otterize-oss-connected.png",alt:"Access graph - Otterize OSS connected",width:"600"}),(0,a.kt)("p",null,"And when you go back to the ",(0,a.kt)("a",{parentName:"p",href:"https://app.otterize.com/access-graph"},"access graph")," (and select your cluster from the dropdown, if needed), you should see the following map for the demo running in your cluster:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Access graph - network map",src:n(8923).Z,width:"2952",height:"1618"})),(0,a.kt)("p",null,"The graph shows services (nodes) connected by arrows (edges) indicating that one service (acting as a client) called another service (acting as a server). The arrows may be due to calls discovered by the network mapper, or to declared client intents YAMLs, or both."),(0,a.kt)("p",null,"In fact the graph shows a lot of interesting insights, such as:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"For each ",(0,a.kt)("strong",{parentName:"li"},"service")," you can see its namespace and environment. You can also see its state as a server and as a client, if applicable.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"As a ",(0,a.kt)("strong",{parentName:"li"},"server"),", you'll see whether it's ",(0,a.kt)("strong",{parentName:"li"},"protected")," against unauthorized access:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"unprotected"),";"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"protected"),"."))),(0,a.kt)("li",{parentName:"ul"},"As a ",(0,a.kt)("strong",{parentName:"li"},"client"),", you'll see whether it's ",(0,a.kt)("strong",{parentName:"li"},"allowed")," to call its servers:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"would be blocked")," from making some of its calls if the corresponding servers were protected;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"allowed")," to make all its calls even when all its servers are protected; or"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#E9615C",fontWeight:"bold"}},"blocked")," now from making some of its calls."))))),(0,a.kt)("li",{parentName:"ul"},"An ",(0,a.kt)("strong",{parentName:"li"},"arrow")," (","\u2192",") indicates an intent by a client to call a server. It's derived from any ",(0,a.kt)("strong",{parentName:"li"},"discovered intent")," ","\u2014"," a call discovered by the network mapper ","\u2014"," and any explicitly ",(0,a.kt)("strong",{parentName:"li"},"declared intent")," that the client declared in its ",(0,a.kt)("inlineCode",{parentName:"li"},"ClientIntents")," YAML.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Its color indicates the blocking status of calls from that client to that server:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"would be blocked")," if the server were protected;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"allowed")," even when the server is protected; or"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("span",{style:{color:"#E9615C",fontWeight:"bold"}},"blocked")," right now.")))))),(0,a.kt)("p",null,"For our demo, the services and the arrows are all ",(0,a.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"yellow")," because the servers aren't (yet) protected, and because we haven't declared any intents so calls would be blocked if the servers were protected."),(0,a.kt)("p",null,"The graph can reveal more information but this should suffice for the moment."),(0,a.kt)("p",null,"Otterize can configure several access control mechanisms, such as Istio authorization policies and Kafka ACLs, and the access graph can take into account their combined state. But for this demo, we're only using network policies, so let's adjust the access graph view to only take these network policies into account: at the top right, toggle on \"Use in access graph\" for network policies, toggle off for the others."),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/access-graph-panel.png",alt:"Access graph - access controls panel",width:"800"}),(0,a.kt)("h3",{id:"choose-one-service-to-protect"},"Choose one service to protect"),(0,a.kt)("p",null,"Now let's prepare to protect just one service, but remain in shadow mode: no actual network policies, yet. We'll verify no intended access would be blocked before turning on the network policy protection."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Which service should you protect? That's up to you: maybe you have a particularly sensitive one that's higher priority; maybe you'd rather start with a less important one, until you feel confident."),(0,a.kt)("p",{parentName:"admonition"},"In our case, we'll choose the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),".")),(0,a.kt)("p",null,"Zoom the access graph a bit to enlarge it around the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Zoom to see productcatalogservice",src:n(842).Z,width:"2356",height:"1690"})),(0,a.kt)("p",null,"Click on the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," to show more details about it:"),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-no-intents.png",alt:"Clicked on productcatalogservice"}),(0,a.kt)("p",null,"We can see that:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"As a server, it's currently ",(0,a.kt)("strong",{parentName:"li"},"unprotected")," (specifically, by network policies); that's expected, as we haven't yet turned on protection."),(0,a.kt)("li",{parentName:"ul"},"It ",(0,a.kt)("strong",{parentName:"li"},"would block its clients if it were protected")," (because there would be no network policies allowing their access)."),(0,a.kt)("li",{parentName:"ul"},"To authorize its clients' access, we're told to ",(0,a.kt)("strong",{parentName:"li"},"declare their intents")," (which would generate those network policies ","\u2014"," this is what IBAC means, after all).")),(0,a.kt)("p",null,"Go ahead and close the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," details. It's time to declare its clients' intents."),(0,a.kt)("details",null,(0,a.kt)("summary",null,(0,a.kt)("b",null,"Optional: Understanding intents from the access graph")),(0,a.kt)("p",null,"The access graph shows three services calling the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),": ",(0,a.kt)("inlineCode",{parentName:"p"},"frontend"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"recommendationservice"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"checkoutservice"),'. The access graph shows an arrow between a client and a server if the network mapper discovered calls were happening ("discovered intent"), or if the client explicitly declared an intent to call the server, or both.'),(0,a.kt)("p",null,"Click, for example, on the yellow arrow from ",(0,a.kt)("inlineCode",{parentName:"p"},"frontend")," ","\u2192"," ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/frontend-calls-productcatalogservice-no-intents.png",alt:"Clicked on frontend to productcatalogservice",width:"600"}),(0,a.kt)("p",null,"We see that:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"There is a discovered intent, but without a corresponding declared intent."),(0,a.kt)("li",{parentName:"ul"},"Access would therefore be blocked, once the ",(0,a.kt)("inlineCode",{parentName:"li"},"productcatalogservice")," server is protected."))),(0,a.kt)("h3",{id:"declare-client-intents"},"Declare client intents"),(0,a.kt)("p",null,"The graph visually tells us we'll need to declare all 3 of those clients' intents:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"frontend")," ","\u2192"," ",(0,a.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),"."),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"recommendationservice")," ","\u2192"," ",(0,a.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),"."),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("inlineCode",{parentName:"li"},"checkoutservice")," ","\u2192"," ",(0,a.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),".")),(0,a.kt)("p",null,"But you don't actually have to look at the graph, nor know in advance the way the demo app is supposed to work. You can auto-generate the intents."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"It's likely you'll want the client devs who own the ",(0,a.kt)("inlineCode",{parentName:"p"},"frontend"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"recommendationservice"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"checkoutservice")," to eventually own those intent declarations, evolve them with their client code as their clients' needs change, review and approve them when they do, etc. They can then serve themselves, and make sure they can access the servers they need, while those servers remain protected."),(0,a.kt)("p",{parentName:"admonition"},"But if you're just getting started with IBAC, and want to first see it in production before getting client devs involved, you can just auto-generate the needed client intents. In fact, you don't need to know in advance which clients call the server: the network mapper will tell you all you need. Just make sure there is representative traffic (load) in your cluster so that the network mapper will see all the expected call patterns.")),(0,a.kt)("p",null,"Let's ask the network mapper to export all the client intents it discovered for the clients of ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"otterize network-mapper export --server productcatalogservice.otterize-ecom-demo\n")),(0,a.kt)("p",null,"Here's the output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha3\nkind: ClientIntents\nmetadata:\n  name: checkoutservice\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: checkoutservice\n  calls:\n    - name: cartservice\n    - name: currencyservice\n    - name: emailservice\n    - name: kafka\n    - name: paymentservice\n    - name: productcatalogservice\n    - name: shippingservice\n---\napiVersion: k8s.otterize.com/v1alpha3\nkind: ClientIntents\nmetadata:\n  name: frontend\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: frontend\n  calls:\n    - name: adservice\n    - name: cartservice\n    - name: checkoutservice\n    - name: currencyservice\n    - name: productcatalogservice\n    - name: recommendationservice\n    - name: shippingservice\n---\napiVersion: k8s.otterize.com/v1alpha3\nkind: ClientIntents\nmetadata:\n  name: recommendationservice\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: recommendationservice\n  calls:\n    - name: productcatalogservice\n")),(0,a.kt)("p",null,"These are indeed the 3 clients of the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),"."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"The network mapper detected that these clients will call many servers besides the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),", as you would expect by looking at the access graph."),(0,a.kt)("p",{parentName:"admonition"},"Even though we're only looking to protect the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," now, it's ",(0,a.kt)("strong",{parentName:"p"},"best to declare all of those calls")," from those 3 clients: those intents reflect  the actual intent of the code, declaring them won't interfere with anything, and it will get us ready to protect those other servers too, in the future.")),(0,a.kt)("p",null,"Let's apply these client intents:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"otterize network-mapper export --server productcatalogservice.otterize-ecom-demo \\\n| kubectl apply -f -\n")),(0,a.kt)("p",null,"If we now look at the access graph, lo and behold: the lines and arrows from all 3 clients to ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," are now green: all the necessary intents have been declared. (And a lot of other lines are now green too, since these clients also call many other servers; these other servers may soon be ready to protect too.)"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"3 intents declared",src:n(418).Z,width:"2560",height:"1480"})),(0,a.kt)("p",null,"You can look into at any of the calls to the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," and see they would not be blocked if this server were protected, e.g.:"),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/frontend-calls-productcatalogservice-with-intents.png",alt:"Clicked on frontend to productcatalogservice",width:"600"}),(0,a.kt)("p",null,"And you can verify the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," would not block ",(0,a.kt)("em",{parentName:"p"},"any")," of its discovered clients by clicking on it:"),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-with-intents.png",alt:"Clicked on productcatalogservice",width:"600"}),(0,a.kt)("p",null,"The server is still ",(0,a.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"yellow")," because it's unprotected ","\u2014"," let's fix that."),(0,a.kt)("h3",{id:"protect-the-productcatalogservice"},"Protect the ",(0,a.kt)("inlineCode",{parentName:"h3"},"productcatalogservice")),(0,a.kt)("p",null,"Now that we've verified no intended clients would be blocked, we can safely protect the server."),(0,a.kt)("p",null,"To do so, recall that we configured Otterize OSS to be in the ",(0,a.kt)("inlineCode",{parentName:"p"},"defaultShadow")," mode: by default, it's in shadow mode for all services, not actually managing network policies for them. To protect a service is a simple matter of applying a ",(0,a.kt)("inlineCode",{parentName:"p"},"ProtectedService")," YAML for it, overriding the default for it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha3\nkind: ProtectedService\nmetadata:\n  name: productcatalogservice\n  namespace: otterize-ecom-demo\nspec:\n  name: productcatalogservice\n\n")),(0,a.kt)("p",null,"Let's apply this file to our cluster:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -n otterize-ecom-demo -f ${ABSOLUTE_URL}/code-examples/guides/protect-1-service-network-policies/protect-productcatalogservice.yaml\n")),(0,a.kt)("p",null,"This has two effects:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Applies a default-deny ingress network policy to the ",(0,a.kt)("inlineCode",{parentName:"li"},"productcatalogservice")," to protect it against unauthorized (undeclared) access."),(0,a.kt)("li",{parentName:"ol"},"Creates and manages network policies (including managing labels on client pods, this namespace, and this server pod) for all declared access. In other words, it enforces network policies only ",(0,a.kt)("strong",{parentName:"li"},"for this ",(0,a.kt)("inlineCode",{parentName:"strong"},"productcatalogservice")," server"),".")),(0,a.kt)("p",null,"Let's look again at the access graph to see what happened in the cluster:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"3 intents declared and server protected",src:n(2615).Z,width:"2496",height:"1364"})),(0,a.kt)("p",null,"Sure enough, the ",(0,a.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," is ",(0,a.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"green"),": it's ",(0,a.kt)("strong",{parentName:"p"},"protected against unauthorized access"),", and ",(0,a.kt)("strong",{parentName:"p"},"allowing authorized clients")," since its clients' arrows are green. Clicking on it confirms this:"),(0,a.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-with-intents-protected.png",alt:"Clicked on productcatalogservice",width:"600"}),(0,a.kt)("h3",{id:"ready-for-production"},"Ready for production"),(0,a.kt)("h4",{id:"will-load-balancers-ingress-and-other-external-traffic-be-affected"},"Will load balancers, ingress, and other external traffic be affected?"),(0,a.kt)("p",null,"The intents operator automatically detects resources of kind ",(0,a.kt)("inlineCode",{parentName:"p"},"Service")," (with type ",(0,a.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"NodePort"),"), or of kind ",(0,a.kt)("inlineCode",{parentName:"p"},"Ingress"),", and creates network policies to allow external traffic to relevant pods."),(0,a.kt)("p",null,"You do not need to configure anything to get this to work. ",(0,a.kt)("a",{parentName:"p",href:"/reference/configuration/intents-operator#handling-external-traffic"},"Learn more here.")),(0,a.kt)("h4",{id:"will-admission-webhook-controllers-eg-policy-validators-like-kyverno-be-affected"},"Will admission webhook controllers, e.g. policy validators like Kyverno, be affected?"),(0,a.kt)("p",null,"Since you are not placing a global default-deny policy that would affect controllers in your cluster, only default-deny network policies on individual pods, Otterize will not affect calls to admission webhook controllers and they will continue functioning as before."),(0,a.kt)("h4",{id:"working-with-otterize-in-cicd"},"Working with Otterize in CI/CD"),(0,a.kt)("p",null,"We recommend placing the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClientIntents")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"ProtectedService")," resource YAMLs alongside the services that own them, in their respective Git repositories:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"ProtectedService")," YAMLs alongside the servers they are protecting, e.g. in the Helm chart belonging to the server."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ClientIntents")," YAMLs, whether they were generated from the network mapper or created and maintained by the client developer teams, alongside each client, e.g. in the Helm chart belonging to the client.")),(0,a.kt)("h3",{id:"in-summary"},"In summary"),(0,a.kt)("p",null,"So what have we learned? You can gradually roll out IBAC and drive towards zero trust, service by service, in a safe, predictable, and quick way, by following 4 simple steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Choose a service to protect, say ",(0,a.kt)("inlineCode",{parentName:"li"},"<NAME>.<NAMESPACE>"),"."),(0,a.kt)("li",{parentName:"ol"},"Export its client's intents: ",(0,a.kt)("inlineCode",{parentName:"li"},"otterize network-mapper export --server <NAME>.<NAMESPACE> > protect-<NAME>.yaml"),"."),(0,a.kt)("li",{parentName:"ol"},"Declare those intents: ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl apply -f protect-<NAME>.yaml"),"."),(0,a.kt)("li",{parentName:"ol"},"Now protect that server by ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl apply -f")," with the following YAML:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha3\nkind: ProtectedService\nmetadata:\n  name: <NAME>\n  namespace: <NAMESPACE>\nspec:\n  name: <NAME>\n")),(0,a.kt)("p",null,"Lather, rinse repeat, protecting service after service as you grow more comfortable, with the access graph providing visibility at each step of the way."),(0,a.kt)("h2",{id:"teardown"},"Teardown"),(0,a.kt)("p",null,"To remove the deployed demo run:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl delete -n otterize-ecom-demo -f ${ABSOLUTE_URL}/code-examples/shadow-mode/all.yaml\nkubectl delete -n otterize-ecom-demo -f ${ABSOLUTE_URL}/code-examples/shadow-mode/ecom-demo.yaml\nkubectl delete namespace otterize-ecom-demo\n")))}u.isMDXComponent=!0},2615:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/3-intents-protected-08dcbca874aafc0ec0784148a4304e85.png"},418:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/3-intents-unprotected-481250497b234291a7f95c336c059642.png"},842:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/enlarged-no-intents-9530b2a224103cee9f8d8f8927ed7381.png"},8923:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/network-map-0f2f43c52d941c94aaac2fc92b6d4292.png"}}]);